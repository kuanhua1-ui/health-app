<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CALORIES">    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health App - æ´»åŠ›ç®¡ç†</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f7f9; margin: 0; padding: 15px; color: #333; }
        .card { background: white; max-width: 450px; margin: auto; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 20px; }
        h3 { color: #2c3e50; margin: 0; border-left: 5px solid #27ae60; padding-left: 10px; font-size: 18px; }
        .section { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        
        /* çœ‹æ¿æ¨£å¼ */
        .summary-box { background: #2c3e50; color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .remain-num { font-size: 32px; font-weight: bold; color: #2ecc71; display: block; margin: 5px 0; }
        
        /* åœ–è¡¨æ¨£å¼ */
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .chart-container { margin-top: 10px; max-height: 250px; overflow-y: auto; padding-right: 5px; border-top: 1px solid #fafafa; }
        .bar-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 12px; }
        .bar-label { width: 45px; color: #666; font-weight: bold; }
        .bar-bg { flex-grow: 1; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; position: relative; display: flex; }
        .bar-fill { height: 100%; transition: width 0.5s; }
        .cumulative-box { text-align: center; padding: 12px; background: #f8f9fa; border-radius: 10px; margin-top: 10px; font-weight: bold; border: 1px dashed #ddd; }
        .status-text { text-align: center; font-size: 12px; color: #aaa; margin-top: 5px; }
    </style>
</head>
<body>

<div class="card">
    <div class="summary-box">
        <input type="date" id="logDate" onchange="refreshReview()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; text-align: center; padding: 5px;">
        <div style="margin-top: 15px; opacity: 0.9;">ä»Šæ—¥å‰©é¤˜ç†±é‡</div>
        <span id="remainDisplay" class="remain-num">--</span>
        <div style="font-size: 14px; opacity: 0.8;">
            ä»Šæ—¥ç›®æ¨™: <span id="targetDisplay">--</span> kcal (TDEE-300)
        </div>
        <div id="status" class="status-text" style="color:rgba(255,255,255,0.5)"></div>
    </div>

    <div class="section">
        <div class="chart-header">
            <h3>ğŸ“Š å ±è¡¨å›é¡§</h3>
            <input type="month" id="filterMonth" onchange="updateMonthChartFromUI()" style="width: auto; margin: 0; padding: 5px; font-size: 14px;">
        </div>
        <div id="chartStatus" class="status-text">è¼‰å…¥åœ–è¡¨ä¸­...</div>
        <div id="monthChart" class="chart-container"></div>
        <div id="cumulativeTotal" class="cumulative-box">æœ¬æœˆç´¯è¨ˆï¼š-- kcal</div>
    </div>

    <div class="section">
        <h3>ğŸ½ï¸ æ–°å¢é£²é£Ÿ</h3>
        <select id="mealType">
            <option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option><option>åƒå¤ªèƒ–</option><option>é£²æ–™</option>
        </select>
        <input type="text" id="foodName" placeholder="é£Ÿç‰©åç¨±">
        <input type="number" id="foodCal" placeholder="å¡è·¯é‡Œ (kcal)">
        <textarea id="foodNote" placeholder="å‚™è¨» (é¸å¡«)"></textarea>
        <button onclick="saveMeal()">å„²å­˜ç´€éŒ„</button>
    </div>

    <details class="section">
        <summary style="cursor: pointer; color: #888; font-weight: bold;">âš™ï¸ æ›´æ–° TDEE èº«é«”æ•¸æ“š</summary>
        <div style="padding-top: 10px;">
            <select id="gender"><option value="male">æ€§åˆ¥ï¼šç”·</option><option value="female">æ€§åˆ¥ï¼šå¥³</option></select>
            <input type="number" id="w" placeholder="é«”é‡ (kg)">
            <input type="number" id="h" placeholder="èº«é«˜ (cm)">
            <input type="number" id="a" placeholder="å¹´é½¡">
            <select id="act">
                <option value="1.2">æ´»å‹•é‡ï¼šä¹…å</option>
                <option value="1.375">æ´»å‹•é‡ï¼šè¼•é‡</option>
                <option value="1.55">æ´»å‹•é‡ï¼šä¸­åº¦</option>
                <option value="1.725">æ´»å‹•é‡ï¼šé‡åº¦</option>
            </select>
            <button style="background: #95a5a6;" onclick="calcAndSaveTDEE()">é‡æ–°è¨ˆç®—ä¸¦å„²å­˜</button>
        </div>
    </details>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzruu1VJLg_KjotEodpQB0X5rdswcPwIvBqB423Lfq1ZUum_hrM9GbuE7sKyE5e1Cyvhg/exec'; // å‹™å¿…å¡«å¯«
    
    // åˆå§‹åŒ–è¨­å®š
    const now = new Date();
    document.getElementById('logDate').valueAsDate = now;
    document.getElementById('filterMonth').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

    async function callGAS(data) {
        document.getElementById('status').innerText = "åŒæ­¥ä¸­...";
        try {
            const resp = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
            document.getElementById('status').innerText = "";
            return await resp.text();
        } catch (e) {
            document.getElementById('status').innerText = "é€£ç·šå¤±æ•—";
            return null;
        }
    }

    async function refreshReview() {
        const date = document.getElementById('logDate').value;
        const latestTdeeText = await callGAS({ type: "GET_LATEST_TDEE" });
        if (latestTdeeText && latestTdeeText !== "0") localStorage.setItem('myTDEE', latestTdeeText);
        
        const tdee = parseFloat(localStorage.getItem('myTDEE')) || 2000;
        const targetPerDay = tdee - 300;
        
        document.getElementById('targetDisplay').innerText = targetPerDay;
        const consumed = parseFloat(await callGAS({ type: "GET_TODAY_TOTAL", date: date })) || 0;
        document.getElementById('remainDisplay').innerText = Math.round(targetPerDay - consumed);

        updateMonthChart(targetPerDay);
    }

    // æä¾›çµ¦ UI æœˆä»½é¸æ“‡å™¨ä½¿ç”¨çš„å‡½å¼
    function updateMonthChartFromUI() {
        const tdee = parseFloat(localStorage.getItem('myTDEE')) || 2000;
        updateMonthChart(tdee - 300);
    }

    async function updateMonthChart(targetPerDay) {
        const filterVal = document.getElementById('filterMonth').value;
        if (!filterVal) return;
        const [year, month] = filterVal.split('-');

        document.getElementById('chartStatus').innerText = "æ­£åœ¨æ’ˆå–æ•¸æ“š...";
        const dataJson = await callGAS({ type: "GET_MONTH_DATA", year: parseInt(year), month: parseInt(month) });
        if (!dataJson) return;

        const logs = JSON.parse(dataJson);
        const chartDiv = document.getElementById('monthChart');
        const cumulativeDiv = document.getElementById('cumulativeTotal');
        chartDiv.innerHTML = "";

        let cumulative = 0;
        const lastDay = new Date(year, month, 0).getDate();
        const curDate = new Date();
        const displayUntil = (parseInt(year) == curDate.getFullYear() && parseInt(month) == (curDate.getMonth() + 1)) ? curDate.getDate() : lastDay;

        for (let i = 1; i <= displayUntil; i++) {
            const dateStr = `${year}-${month.padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const dayConsumed = logs[dateStr] || 0;
            const diff = dayConsumed - targetPerDay;
            cumulative += diff;

            const row = document.createElement('div');
            row.className = 'bar-row';
            const isDeficit = diff <= 0;
            const barWidth = Math.min(Math.abs(diff) / 10, 100);
            
            row.innerHTML = `
                <div class="bar-label">${i}æ—¥</div>
                <div class="bar-bg">
                    <div class="bar-fill" style="width: ${barWidth}%; background: ${isDeficit ? '#2ecc71' : '#e74c3c'}; margin-left: ${isDeficit ? '0' : 'auto'};"></div>
                </div>
                <div style="width: 45px; text-align: right; font-weight: bold; color: ${isDeficit ? '#27ae60' : '#c0392b'}">${Math.round(diff)}</div>
            `;
            chartDiv.appendChild(row);
        }
        
        document.getElementById('chartStatus').innerText = "";
        cumulativeDiv.innerText = `${month}æœˆ ç†±é‡ç›ˆé¤˜/èµ¤å­—ï¼š${Math.round(cumulative)} kcal`;
        cumulativeDiv.style.color = cumulative <= 0 ? "#27ae60" : "#c0392b";
    }

    async function saveMeal() {
        const name = document.getElementById('foodName').value;
        const cal = document.getElementById('foodCal').value;
        if (!name || !cal) return alert("è«‹è¼¸å…¥å…§å®¹");

        await callGAS({
            type: "SAVE_LOG",
            date: document.getElementById('logDate').value,
            mealType: document.getElementById('mealType').value,
            name: name,
            calories: cal,
            note: document.getElementById('foodNote').value
        });
        
        document.getElementById('foodName').value = "";
        document.getElementById('foodCal').value = "";
        refreshReview();
    }

    async function calcAndSaveTDEE() {
        const g = document.getElementById('gender').value;
        const w = document.getElementById('w').value;
        const h = document.getElementById('h').value;
        const a = document.getElementById('a').value;
        const act = document.getElementById('act').value;

        let bmr = (g === 'male') ? (10 * w + 6.25 * h - 5 * a + 5) : (10 * w + 6.25 * h - 5 * a - 161);
        const tdee = Math.round(bmr * act);
        
        await callGAS({ type: "SAVE_TDEE", date: document.getElementById('logDate').value, tdee: tdee });
        alert("è¨­å®šå·²åŒæ­¥");
        refreshReview();
    }

    window.onload = refreshReview;
</script>
</body>
</html>

